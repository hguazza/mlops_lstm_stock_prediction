name: Docker Build and Test

on:
  push:
    branches: [main, master]
    tags: ['v*']
  pull_request:
    branches: [main, master]

jobs:
  docker-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -t stock-prediction-api:${{ github.sha }} .
          docker tag stock-prediction-api:${{ github.sha }} stock-prediction-api:latest

      - name: Start Docker container
        run: |
          docker run -d \
            --name test-api \
            -p 8000:8000 \
            -e PYTHONUNBUFFERED=1 \
            stock-prediction-api:${{ github.sha }}

      - name: Wait for API to be ready
        run: |
          echo "Waiting for API to start..."
          for i in {1..30}; do
            if curl -f http://localhost:8000/api/v1/health; then
              echo "API is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done

      - name: Test health endpoint
        run: |
          response=$(curl -s http://localhost:8000/api/v1/health)
          echo "Health response: $response"
          echo "$response" | jq -e '.status == "healthy" or .status == "unhealthy"'

      - name: Test root endpoint
        run: |
          response=$(curl -s http://localhost:8000/)
          echo "Root response: $response"
          echo "$response" | jq -e '.name'

      - name: Test docs endpoint
        run: |
          curl -f http://localhost:8000/docs

      - name: View container logs
        if: always()
        run: docker logs test-api

      - name: Stop and remove container
        if: always()
        run: |
          docker stop test-api || true
          docker rm test-api || true

      - name: Check image size
        run: |
          echo "Image size:"
          docker images stock-prediction-api:latest --format "{{.Size}}"

      - name: Test docker-compose
        run: |
          docker-compose config
          echo "docker-compose configuration is valid"

  docker-compose-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create required directories
        run: |
          mkdir -p models

      - name: Start services with docker-compose
        run: |
          docker-compose up -d

      - name: Wait for services to be ready
        run: |
          echo "Waiting for services..."
          sleep 30

      - name: Check services are running
        run: |
          docker-compose ps

      - name: Test API health
        run: |
          curl -f http://localhost:8000/api/v1/health

      - name: View API logs
        if: always()
        run: docker-compose logs api

      - name: View MLflow logs
        if: always()
        run: docker-compose logs mlflow-ui

      - name: Stop services
        if: always()
        run: docker-compose down -v
